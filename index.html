<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Ideal Christmas Gift Fund</title>
    <!-- Tailwind CSS for utility classes --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styling and Background --- */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            height: 100%;
            background: #2a1a0f;
            overflow-x: hidden;
            color: #fff;
        }

        .cabin {
            position: relative;
            min-height: 100vh;
            padding: 20px 0;
            /* **BACKGROUND IMAGE: Cozy cabin with Christmas tree and Santa's sled** */
            /* *** UPDATED TO USE RELATIVE PATH FOR GITHUB HOSTING *** */
            background: url('./assets/cozy-cabin.png') no-repeat center center fixed;
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .content {
            background: rgba(0,0,0,0.8); /* Slightly darker background for readability */
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 40px rgba(61, 149, 206, 0.7); /* Extra glow effect */
            border: 2px solid #3d95ce;
        }

        /* --- Donation Meter Styling (BIGGER AND FLASHIER) --- */
        .donation-bar-container {
            background: rgba(255,255,255,0.2);
            border-radius: 12px; /* Slightly larger radius */
            overflow: hidden;
            margin-bottom: 30px; /* More space around the centerpiece */
            height: 45px; /* Significantly increased height */
            position: relative;
            border: 2px solid #3d95ce; /* Thicker border */
            box-shadow: 0 0 20px rgba(61, 149, 206, 0.8); /* Stronger glow */
        }

        .donation-bar {
            height: 100%;
            width: 0;
            /* Flashy gradient effect */
            background: linear-gradient(90deg, #3d95ce 0%, #6ab7ff 100%); 
            text-align: center;
            line-height: 45px; /* Matched to new height */
            color: white;
            font-weight: bold;
            border-radius: 10px 0 0 10px;
            transition: width 1.2s ease-in-out; /* Slower transition for drama */
            white-space: nowrap;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3); /* Inner shadow for depth */
        }

        .goal-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 45px; /* Matched to new height */
            top: 0;
            left: 0;
            color: white;
            z-index: 2;
            font-size: 18px; /* Bigger font */
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 1); /* Better readability */
        }

        /* Style for Goal Reached */
        .donation-bar-container.goal-reached .donation-bar {
            background: linear-gradient(90deg, #ffd700 0%, #ff8c00 100%); /* Gold/Orange Gradient */
        }

        /* --- Venmo and Form Styling --- */
        .donate-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #3d95ce;
            color: white;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        .donate-btn:hover {
            background-color: #2c729f;
        }

        .donate-btn:active {
            transform: scale(0.99);
        }

        /* --- Comment Section Styling --- */
        .comment-section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        #commentList {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        #commentList li {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #commentList li:last-child {
            border-bottom: none;
        }

        .comment-name {
            font-weight: bold;
            color: #90ee90;
            margin-right: 5px;
        }
        .error-message {
            color: #f87171; /* Red */
            margin-bottom: 10px;
        }
    </style>
    <!-- Firebase SDK Imports --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Uncomment to see Firebase logs
        
        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- Configuration ---
        const DONATION_GOAL = 700; // <<< GOAL UPDATED TO $700
        const VENMO_USERNAME = 'Erik-Davis-138'; 
        
        // Firestore paths
        const STATUS_DOC_PATH = `/artifacts/${appId}/public/data/fundraiser/status`;
        const COMMENTS_COLLECTION_PATH = `/artifacts/${appId}/public/data/comments`;

        // --- Initialization and Authentication ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Sign in anonymously if initial token is not available
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Custom token sign-in failed. Attempting anonymous sign-in.", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                isAuthReady = true;
                
                // Start listening to data once auth is ready
                setupRealtimeListeners();
            });
        }
        
        // --- Realtime Data Listeners ---
        function setupRealtimeListeners() {
            if (!isAuthReady || !db) return;

            // 1. Listen for Donation Updates
            const statusDocRef = doc(db, STATUS_DOC_PATH);
            onSnapshot(statusDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    const totalAmount = data.totalDonations || 0;
                    updateDonationBar(totalAmount);
                } else {
                    // Initialize the document if it doesn't exist. 
                    // Changed updateDoc to setDoc to prevent 'No document to update' error.
                    setDoc(statusDocRef, { totalDonations: 0, goal: DONATION_GOAL }, { merge: true })
                        .catch(err => console.error("Error initializing status doc:", err));
                    updateDonationBar(0);
                }
            }, (error) => {
                console.error("Error listening to donation status:", error);
            });

            // 2. Listen for Comments
            const commentsQuery = query(collection(db, COMMENTS_COLLECTION_PATH), orderBy('timestamp', 'desc'));
            onSnapshot(commentsQuery, (snapshot) => {
                renderComments(snapshot.docs);
            }, (error) => {
                console.error("Error listening to comments:", error);
            });
        }

        // --- Donation Logic ---
        function updateDonationBar(totalDonations) {
            const container = document.getElementById('donationBarContainer');
            const bar = document.getElementById('donationBar');
            const goalText = document.getElementById('goalText');
            
            const percent = Math.min((totalDonations / DONATION_GOAL) * 100, 100);
            
            bar.style.width = percent + '%';
            goalText.textContent = '$' + totalDonations.toFixed(2) + ' / $' + DONATION_GOAL + ' Goal';

            if (percent >= 100) {
                container.classList.add('goal-reached');
                goalText.textContent = 'GOAL REACHED! üéâ';
            } else {
                container.classList.remove('goal-reached');
            }
        }
        
        async function submitDonation() {
            if (!isAuthReady) return console.log("Authentication not ready.");

            const amountInput = document.getElementById('donationAmountInput');
            const amountStr = amountInput.value.trim();
            const amount = parseFloat(amountStr);

            if (isNaN(amount) || amount <= 0) {
                document.getElementById('donationError').textContent = "Please enter a valid amount (e.g., 20.00).";
                return;
            }
            document.getElementById('donationError').textContent = ""; // Clear error

            const statusDocRef = doc(db, STATUS_DOC_PATH);

            try {
                // Use a transaction to safely update the donation total
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(statusDocRef);
                    const currentTotal = docSnapshot.data()?.totalDonations || 0;
                    const newTotal = currentTotal + amount;

                    transaction.update(statusDocRef, { totalDonations: newTotal });
                });
                
                console.log(`Donation of $${amount.toFixed(2)} recorded.`);
                
                // Clear input
                amountInput.value = '';
                
                // Open Venmo link for actual payment (This is a helpful external link for the user)
                window.open(`https://venmo.com/${VENMO_USERNAME}`, '_blank');
                
                document.getElementById('donationStatus').textContent = `Thank you! Please complete your $${amount.toFixed(2)} payment to @${VENMO_USERNAME} on Venmo.`;

            } catch (e) {
                console.error("Transaction failed:", e);
                document.getElementById('donationStatus').textContent = "Error recording donation. Please try again.";
            }
        }


        // --- Comment Logic ---
        function renderComments(docs) {
            const list = document.getElementById('commentList');
            list.innerHTML = ''; 

            docs.forEach(doc => {
                const commentData = doc.data();
                const li = document.createElement('li');
                
                // Format timestamp
                const date = commentData.timestamp?.toDate ? commentData.timestamp.toDate() : new Date();
                const timeString = date.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
                const dateString = date.toLocaleDateString('en-US');

                li.innerHTML = `
                    <p class="mb-1">
                        <span class="comment-name">${commentData.name}:</span>
                        ${commentData.comment}
                    </p>
                    <small class="text-gray-400 text-xs">${dateString} at ${timeString}</small>
                `;
                list.appendChild(li);
            });
        }
        
        async function addComment() {
            if (!isAuthReady) return console.log("Authentication not ready.");
            
            const nameInput = document.getElementById('nameInput');
            const commentInput = document.getElementById('commentInput');
            const commentError = document.getElementById('commentError');

            const name = nameInput.value.trim();
            const comment = commentInput.value.trim();

            if (name === "" || comment === "") {
                commentError.textContent = "Both your name and a comment are required.";
                return;
            }
            commentError.textContent = "";

            try {
                await addDoc(collection(db, COMMENTS_COLLECTION_PATH), {
                    name: name,
                    comment: comment,
                    timestamp: serverTimestamp(),
                    userId: userId 
                });
                
                // Clear inputs after posting
                commentInput.value = '';
                nameInput.value = '';
                
            } catch (e) {
                console.error("Error adding document: ", e);
                commentError.textContent = "Could not post comment. Try again.";
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);
        
        // Expose function globally for HTML button click
        window.addComment = addComment;
        window.submitDonation = submitDonation;
    </script>
</head>
<body>

<div class="cabin">
    <div class="content">
        <!-- ORIGINAL: Generic Christmas Gift Fund Title -->
        <h1 class="text-3xl font-bold mb-5 text-center text-teal-300">üéÑ Fund My Dream Gift üéÅ</h1>
        <!-- ORIGINAL: Generic Christmas Gift Fund Description -->
        <p class="text-center mb-6 text-sm">Hi there! I‚Äôve been saving for a long time to get my dream gaming PC, and I‚Äôm almost at the finish line. Can you help me reach my goal?</p>

        <!-- Donation Meter (Now much larger and flashier) --><div class="donation-bar-container" id="donationBarContainer">
            <div class="donation-bar" id="donationBar"></div>
            <div class="goal-text" id="goalText">$0 / $700 Goal</div>
        </div>
        
        <!-- Venmo Donation Section -->
        <div class="mb-8 p-4 bg-gray-900 bg-opacity-50 rounded-lg border-2 border-teal-500">
            <!-- ORIGINAL: Donation Section Title -->
            <h3 class="text-xl font-semibold mb-3 text-teal-300">Donate via Venmo</h3>
            <!-- ORIGINAL: Donation Paragraph -->
            <p class="text-sm mb-4">
                To donate, enter the amount you wish to contribute below. Clicking the button will open Venmo to complete the payment to <span class="font-bold text-teal-300">@Erik-Davis-138</span> on Venmo.
            </p>
            
            <div class="flex space-x-2 mb-2">
                <input type="number" id="donationAmountInput" placeholder="Enter $ amount" class="p-3 w-2/3 rounded-lg text-black" min="1">
                <button onclick="submitDonation()" class="donate-btn w-1/3 p-3">
                    Donate
                </button>
            </div>
            <p id="donationStatus" class="text-sm text-center mt-2 h-6"></p>
            <p id="donationError" class="error-message text-center mt-2"></p>
        </div>


        <!-- Comment Section -->
        <div class="comment-section">
            <!-- ORIGINAL: Comment Section Title -->
            <h3 class="text-xl font-semibold mb-3 text-white">Leave a Christmas Wish!</h3>
            <!-- ORIGINAL: Name Placeholder -->
            <input type="text" id="nameInput" placeholder="Your Name (required)" class="p-2 w-full mb-2 rounded-lg text-black">
            <!-- ORIGINAL: Comment Placeholder -->
            <input type="text" id="commentInput" placeholder="Your comment..." class="p-2 w-full mb-3 rounded-lg text-black">
            <!-- ORIGINAL: Comment Button Text -->
            <button onclick="addComment()" class="bg-green-600 hover:bg-green-700 p-3 rounded-lg text-white font-bold transition">
                Post Comment
            </button>
            <p id="commentError" class="error-message"></p>
            <ul id="commentList" class="mt-4">
                <!-- Realtime comments will be rendered here --><li class="text-gray-400 text-center">Loading comments...</li>
            </ul>
        </div>
    </div>
</div>

</body>
</html>